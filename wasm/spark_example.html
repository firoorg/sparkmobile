<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call js_createSparkMintRecipients</title>
    <script src="spark.js"></script>
</head>
<body>
    <h1>Call js_createSparkMintRecipients Example</h1>
    <p>Open the console to see the output.</p>

    <script>
        // Wait for the WebAssembly module to load
        Module['onRuntimeInitialized'] = function () {
            console.log('WebAssembly Module Loaded');

           try {
            const keyData = new Uint8Array([
                0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10,
                0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 0x20
            ]); // 32 bytes total
            const index = 1; // Example index
            const diversifier = 4n; // Example diversifier
            const is_test_network = 0; // Working with the main network, therefore

            // Allocate memory in WASM for the 32-byte key data
            const keyDataPtr = Module._malloc(keyData.length);
            Module.HEAPU8.set(keyData, keyDataPtr);

            // Call the `js_createSpendKeyData` function to create SpendKeyData
            const spendKeyDataObj = Module.ccall(
                "js_createSpendKeyData",    // function name
                "number",                   // return type
                ["number", "number"],       // argument types
                [keyDataPtr, index]         // arguments
            );

            if (spendKeyDataObj === 0) {
                console.error("Failed to create SpendKeyData");
                Module._free(keyDataPtr);
                return;
            }

            // Call the `js_createSpendKey` function to create a SpendKey
            const spendKeyObj = Module.ccall(
                "js_createSpendKey",
                "number",                   // return type
                ["number"],                 // argument types
                [spendKeyDataObj]           // arguments
            );

            if (spendKeyObj === 0) {
                console.error("Failed to create SpendKey");
                Module.ccall("js_freeSpendKeyData", null, ["number"], [spendKeyDataObj]);
                Module._free(keyDataPtr);
                return;
            }

            // Get the `s1` scalar value as a string using `js_getSpendKey_s1`
            const s1 = Module.ccall(
                "js_getSpendKey_s1",        // function name
                "string",                   // return type
                ["number"],                 // argument types
                [spendKeyObj]               // arguments
            );
            console.log("SpendKey s1 Scalar:", s1);

            // Get the `s2` scalar value as a string using `js_getSpendKey_s2`
            const s2 = Module.ccall(
                "js_getSpendKey_s2",        // function name
                "string",                   // return type
                ["number"],                 // argument types
                [spendKeyObj]               // arguments
            );
            console.log("SpendKey s2 Scalar:", s2);

            // Get the `r` scalar value as a string using `js_getSpendKey_r`
            const r = Module.ccall(
                "js_getSpendKey_r",        // function name
                "string",                   // return type
                ["number"],                 // argument types
                [spendKeyObj]               // arguments
            );
            console.log("SpendKey r Scalar:", r);

            // Get the `s1` scalar value as a hex string using `js_getSpendKey_s1_hex`
            const s1_hex = Module.ccall(
                "js_getSpendKey_s1_hex",        // function name
                "string",                   // return type
                ["number"],                 // argument types
                [spendKeyObj]               // arguments
            );
            console.log("SpendKey s1 Scalar Hex:", s1_hex);

            // Get the `s2` scalar value as a hex string using `js_getSpendKey_s2_hex`
            const s2_hex = Module.ccall(
                "js_getSpendKey_s2_hex",        // function name
                "string",                   // return type
                ["number"],                 // argument types
                [spendKeyObj]               // arguments
            );
            console.log("SpendKey s2 Scalar Hex:", s2_hex);

            // Get the `r` scalar value as a hex string using `js_getSpendKey_r_hex`
            const r_hex = Module.ccall(
                "js_getSpendKey_r_hex",        // function name
                "string",                   // return type
                ["number"],                 // argument types
                [spendKeyObj]               // arguments
            );
            console.log("SpendKey r Scalar Hex:", r_hex);

            // Call the `js_createFullViewKey` function to create a FullViewKey
            const fullViewKeyObj = Module.ccall(
                "js_createFullViewKey",
                "number",                   // return type
                ["number"],                 // argument types
                [spendKeyObj]           // arguments
            );

            if (fullViewKeyObj === 0) {
                console.error("Failed to create FullViewKey");
                Module.ccall("js_freeSpendKey", null, ["number"], [spendKeyObj]);
                Module.ccall("js_freeSpendKeyData", null, ["number"], [spendKeyDataObj]);
                Module._free(keyDataPtr);
                return;
            }

            // Call the `js_createIncomingViewKey` function to create an IncomingViewKey
            const incomingViewKeyObj = Module.ccall(
                "js_createIncomingViewKey",
                "number",                   // return type
                ["number"],                 // argument types
                [fullViewKeyObj]           // arguments
            );

            if (incomingViewKeyObj === 0) {
                console.error("Failed to create IncomingViewKey");
                Module.ccall("js_freeFullViewKey", null, ["number"], [fullViewKeyObj]);
                Module.ccall("js_freeSpendKey", null, ["number"], [spendKeyObj]);
                Module.ccall("js_freeSpendKeyData", null, ["number"], [spendKeyDataObj]);
                Module._free(keyDataPtr);
                return;
            }

            // Call the `js_getAddress` function to create an Address
            const addressObj = Module.ccall(
                "js_getAddress",
                "number",                   // return type
                ["number", "number"],                 // argument types
                [incomingViewKeyObj, diversifier]           // arguments
            );

            if (addressObj === 0) {
                console.error("Failed to get Address");
                Module.ccall("js_freeIncomingViewKey", null, ["number"], [incomingViewKeyObj]);
                Module.ccall("js_freeFullViewKey", null, ["number"], [fullViewKeyObj]);
                Module.ccall("js_freeSpendKey", null, ["number"], [spendKeyObj]);
                Module.ccall("js_freeSpendKeyData", null, ["number"], [spendKeyDataObj]);
                Module._free(keyDataPtr);
                return;
            }

            // Encode the address as a string using `js_encodeAddress`
            const address_enc_main = Module.ccall(
                "js_encodeAddress",        // function name
                "string",                   // return type
                ["number", "number"],                 // argument types
                [addressObj, is_test_network]               // arguments
            );
            console.log("Address string (main):", address_enc_main);



                // Create MintedCoinData objects
                const outputsLength = 2; // Example: 2 outputs
                const outputsArray = [];

                for (let i = 0n; i < outputsLength; i++) {
                    const mintedCoinData = Module._js_createMintedCoinData(
                        addressObj,
                        1000n + i * 100n, // Example amount
                        `Memo ${i}` // Example memo
                    );
                    if (!mintedCoinData) {
                        throw new Error(`Failed to create MintedCoinData for index ${i}`);
                    }
                    outputsArray.push(mintedCoinData);
                }

                // Allocate memory for the array of pointers
                const pointerSize = 4; // Pointer = 4 bytes (32-bit) on most systems
                const outputsPointerArray = Module._malloc(outputsLength * pointerSize);

                // Write pointers to the allocated memory
                outputsArray.forEach((outputPointer, index) => {
                    Module.HEAP32[(outputsPointerArray >> 2) + index] = outputPointer;
                });

                // Serial context (dummy data)
                const serialContext = new Uint8Array([0x12, 0x34, 0x56, 0x78, 0x9A, 0xBC]);
                const serialContextPointer = Module._malloc(serialContext.length);
                Module.HEAPU8.set(serialContext, serialContextPointer); // Copy to Wasm memory

                // Call the `js_createSparkMintRecipients` function
                const recipientsVectorPtr = Module._js_createSparkMintRecipients(
                    outputsPointerArray,            // Pointer array with minted coin data
                    outputsLength,                  // Length of the outputs array
                    serialContextPointer,           // Pointer to the serial context
                    serialContext.length,           // Length of the serial context
                    1                               // Generate flag (true)
                );

                if (!recipientsVectorPtr) {
                    throw new Error('Failed to call `js_createSparkMintRecipients`.');
                }

                // Process the recipient data
                const recipientsLength = Module._js_getRecipientVectorLength(recipientsVectorPtr);
                console.log(`Number of Recipients: ${recipientsLength}`);

                for (let i = 0; i < recipientsLength; i++) {
                    const recipientPtr = Module._js_getRecipientAt(recipientsVectorPtr, i);

                    // Access the recipient fields
                    const scriptPubKeySize = Module._js_getRecipientScriptPubKeySize(recipientPtr);
                    const scriptPubKeyPointer = Module._js_getRecipientScriptPubKey(recipientPtr);
                    const scriptPubKey = new Uint8Array(scriptPubKeySize);
                    for (let j = 0; j < scriptPubKeySize; j++) {
                        scriptPubKey[j] = Module.HEAPU8[scriptPubKeyPointer + j];
                    }

                    const amount = Module._js_getRecipientAmount(recipientPtr);
                    const subtractFeeFlag = Module._js_getRecipientSubtractFeeFromAmountFlag(recipientPtr);

                    // Log the received recipient
                    console.log(`Recipient ${i}:`);
                    console.log(`  ScriptPubKey: ${Array.from(scriptPubKey).map(b => b.toString(16).padStart(2, '0')).join('')}`);
                    console.log(`  Amount: ${amount}`);
                    console.log(`  Subtract Fee Flag: ${subtractFeeFlag}`);
                }

                // Free allocated memory
                Module.ccall("js_freeRecipientVector", null, ["number"], [recipientsVectorPtr]);
                Module.ccall("js_freeAddress", null, ["number"], [addressObj]);
                Module.ccall("js_freeIncomingViewKey", null, ["number"], [incomingViewKeyObj]);
                Module.ccall("js_freeFullViewKey", null, ["number"], [fullViewKeyObj]);
                Module.ccall("js_freeSpendKey", null, ["number"], [spendKeyObj]);
                Module.ccall("js_freeSpendKeyData", null, ["number"], [spendKeyDataObj]);
                Module._free(keyDataPtr);
                Module._free(outputsPointerArray);
                Module._free(serialContextPointer);

            } catch (error) {
                console.error('Error:', error);
            }
        };
    </script>
</body>
</html>
